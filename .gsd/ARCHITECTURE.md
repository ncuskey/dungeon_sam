# Architecture

> Auto-generated by /map on February 5, 2026

## Overview

**Dungeon Sam** is a first-person 3D dungeon crawler built with React Three Fiber. The game features procedural dungeon generation, grid-based movement, real-time combat, dynamic lighting, and a fog-of-war minimap system.

```
┌─────────────────────────────────────────┐
│     App.tsx (Game Phase Router)        │
├─────────────────────────────────────────┤
│  GameCanvas (R3F Scene + Controllers)   │
├─────────────────────────────────────────┤
│   gameStore (Zustand State Manager)     │
├─────────────────────────────────────────┤
│  Utils (Dungeon Gen, AI, Textures)      │
└─────────────────────────────────────────┘
```

## Components

### Core Game Loop

#### `App.tsx`
- **Purpose:** Root component and game phase router
- **Location:** `src/App.tsx`
- **Responsibilities:**
  - Renders menu, game canvas, or game over screens based on `gameStore.phase`
  - Manages global audio initialization
  - Provides game overlay UI (HUD, minimap, touch controls)

#### `GameCanvas.tsx`
- **Purpose:** React Three Fiber scene container
- **Location:** `src/components/GameCanvas.tsx`
- **Dependencies:** `@react-three/fiber`, `CameraRig`, `LevelRenderer`, `EnemyRenderer`, `useGameLoop`
- **Responsibilities:**
  - Initializes R3F Canvas with camera settings
  - Orchestrates scene rendering components
  - Provides ambient lighting baseline

### Rendering Components

#### `LevelRenderer.tsx`
- **Purpose:** Renders dungeon geometry, items, and static lights
- **Location:** `src/components/LevelRenderer.tsx`
- **Dependencies:** `gameStore`, `textureGenerator`, `Billboard`
- **Responsibilities:**
  - Generates floor/wall meshes from dungeon map
  - Renders torches as billboards with point lights
  - Renders items (potions, weapons) as billboards
  - Applies procedural textures to geometry

#### `EnemyRenderer.tsx`
- **Purpose:** Renders enemy entities as billboards
- **Location:** `src/components/EnemyRenderer.tsx`
- **Dependencies:** `gameStore`, `Billboard`, `The_Watcher.png`
- **Responsibilities:**
  - Maps enemy positions to 3D world coordinates
  - Displays enemy sprites facing camera

#### `WeaponOverlay.tsx`
- **Purpose:** First-person weapon view with attack animations
- **Location:** `src/components/WeaponOverlay.tsx`
- **Dependencies:** `gameStore`, weapon sprites
- **Responsibilities:**
  - Displays current weapon (fists, sword) in viewport
  - Animates attack sequences (swing, return to idle)
  - Manages animation state with `useRef` timeout cleanup

#### `Billboard.tsx`
- **Purpose:** Reusable camera-facing sprite component
- **Location:** `src/components/Billboard.tsx`
- **Dependencies:** `@react-three/fiber`, `three`
- **Responsibilities:**
  - Renders textured planes that always face camera
  - Used for torches, items, enemies

### Camera & Movement

#### `CameraRig.tsx`
- **Purpose:** Camera controller with lantern tracking
- **Location:** `src/components/CameraRig.tsx`
- **Dependencies:** `@react-three/fiber`, `gameStore`
- **Responsibilities:**
  - Lerps camera position/rotation to player grid position
  - Applies screen shake effects
  - **Manually syncs player lantern position to camera** (critical fix)
  - Returns `<pointLight>` for player's lantern

#### `PlayerController.tsx`
- **Purpose:** Keyboard input handler
- **Location:** `src/components/PlayerController.tsx`
- **Dependencies:** `gameStore`
- **Responsibilities:**
  - Listens for WASD/Arrow keys for movement
  - F key for attack
  - H/1 keys for healing
  - Dispatches actions to `gameStore`

#### `TouchControls.tsx`
- **Purpose:** Mobile touch input overlay
- **Location:** `src/components/TouchControls.tsx`
- **Dependencies:** `gameStore`
- **Responsibilities:**
  - Virtual D-pad for movement
  - Action buttons (attack, heal, settings)
  - Prevents default browser gestures

### UI Components

#### `HUD.tsx`
- **Purpose:** Health bar and weapon display
- **Location:** `src/components/HUD.tsx`
- **Dependencies:** `gameStore`
- **Responsibilities:**
  - Displays current health percentage
  - Shows equipped weapon name

#### `Minimap.tsx`
- **Purpose:** Fog-of-war exploration map
- **Location:** `src/components/Minimap.tsx`
- **Dependencies:** `gameStore`, Canvas 2D API
- **Responsibilities:**
  - Renders dungeon layout with fog-of-war
  - Shows player position and orientation
  - Reveals tiles as player explores

#### `GameOverlay.tsx`
- **Purpose:** Composite UI overlay container
- **Location:** `src/components/GameOverlay.tsx`
- **Dependencies:** `HUD`, `Minimap`, `TouchControls`
- **Responsibilities:**
  - Positions UI elements in viewport
  - Conditionally renders touch controls on mobile

## State Management

### `gameStore.ts`
- **Purpose:** Central Zustand store for all game state
- **Location:** `src/store/gameStore.ts`
- **Dependencies:** `zustand`, `dungeonGenerator`, `ai`, `audioIntegration`
- **State:**
  - `phase`: Game phase (MENU | PLAYING | WON | GAME_OVER)
  - `playerPosition`, `playerDirection`: Grid-based player state
  - `map`: 2D dungeon layout (0=floor, 1=wall)
  - `exploredMap`: Boolean grid for fog-of-war
  - `enemies`: Array of enemy entities with HP
  - `lights`: Static torch positions
  - `items`: Ground items (potions, weapons)
  - `inventory`: Player's held items and equipped weapon
  - `playerHealth`, `shake`, `lastAttackTime`: Combat state
- **Actions:**
  - Movement: `moveForward`, `moveBackward`, `turnLeft`, `turnRight`
  - Combat: `playerAttack`, `tickGame` (enemy AI loop)
  - Items: `pickupItem`, `equipWeapon`, `useItem`
  - Exploration: `revealMap` (fog-of-war updates)
  - Lifecycle: `startGame`, `resetGame`

## Utilities

### `dungeonGenerator.ts`
- **Purpose:** Procedural dungeon generation
- **Location:** `src/utils/dungeonGenerator.ts`
- **Algorithm:** Recursive backtracking maze generation
- **Outputs:**
  - `map`: 2D grid of walls/floors
  - `startPosition`: Player spawn point
  - `exitPosition`: Goal location
  - `initialEnemies`: Enemy spawn positions
  - `initialItems`: Potion/weapon spawn positions

### `ai.ts`
- **Purpose:** Enemy pathfinding and behavior
- **Location:** `src/utils/ai.ts`
- **Algorithm:** Manhattan distance movement toward player
- **Behavior:**
  - Moves toward player if not adjacent
  - Stays put if adjacent (allows diagonal attacks)
  - Respects wall collision

### `textureGenerator.ts`
- **Purpose:** Procedural texture generation
- **Location:** `src/utils/textureGenerator.ts`
- **Outputs:**
  - Floor textures (stone pattern with noise)
  - Wall textures (brick pattern)
  - Canvas-based generation for performance

## Audio System

### `SoundManager.ts`
- **Purpose:** Web Audio API sound manager
- **Location:** `src/audio/SoundManager.ts`
- **Dependencies:** `howler`
- **Responsibilities:**
  - Loads and caches audio files
  - Provides play/stop/volume controls
  - Manages background music loops

### `audioIntegration.ts`
- **Purpose:** Game-specific audio triggers
- **Location:** `src/audio/audioIntegration.ts`
- **Dependencies:** `SoundManager`
- **Exports:**
  - `playAttackSound()`: Combat SFX
  - `playHealSound()`: Potion SFX

## Hooks

### `useGameLoop.ts`
- **Purpose:** Game tick loop (enemy AI, state cleanup)
- **Location:** `src/hooks/useGameLoop.ts`
- **Dependencies:** `gameStore`
- **Behavior:**
  - Runs `tickGame()` every 500ms
  - Decrements screen shake over time

### `useAudio.ts`
- **Purpose:** Audio initialization and lifecycle
- **Location:** `src/hooks/useAudio.ts`
- **Dependencies:** `SoundManager`
- **Behavior:**
  - Initializes audio on user interaction
  - Starts background music
  - Cleanup on unmount

## Data Flow

### Game Initialization
1. `main.tsx` renders `App.tsx`
2. `App.tsx` shows menu (phase: MENU)
3. User clicks "ENTER DUNGEON"
4. `gameStore.startGame()` generates dungeon and spawns entities
5. Phase changes to PLAYING
6. `GameCanvas` mounts, initializing R3F scene

### Movement Flow
1. User presses WASD/Arrow key
2. `PlayerController` calls `gameStore.moveForward()`
3. Store validates move (checks walls)
4. Updates `playerPosition` and `exploredMap` atomically
5. `CameraRig` lerps camera to new position in `useFrame`
6. `Minimap` re-renders with revealed tiles

### Combat Flow
1. User presses F or taps attack button
2. `PlayerController` calls `gameStore.playerAttack()`
3. Store checks cooldown (`lastAttackTime`)
4. Finds enemies in attack range (adjacent or diagonal)
5. Applies weapon damage, plays SFX, triggers screen shake
6. `WeaponOverlay` animates attack sequence
7. `useGameLoop` tick updates enemy AI
8. Enemies move toward player and attack if adjacent

### Lighting Flow
1. `gameStore` generates static torch positions via `generateLights()`
2. `LevelRenderer` renders torches as `<Billboard>` + `<pointLight>`
3. `CameraRig` returns player's `<pointLight>` lantern
4. **Every frame**: `CameraRig.useFrame()` manually syncs lantern position to camera
5. R3F renders scene with combined lighting

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| DigitalOcean Droplet | Hosting | Static site deployment via `deploy.sh` |
| dungeonsam.site | Domain | Production URL |

## Technical Debt

- [ ] **Bundle Size**: Single 975KB JS bundle (consider code splitting)
- [ ] **No Tests**: Zero test coverage (add Vitest + React Testing Library)
- [ ] **Hardcoded Constants**: Magic numbers scattered (consolidate to config)
- [ ] **No Error Boundaries**: React errors crash entire app
- [ ] **Mobile Performance**: No FPS throttling or quality settings
- [ ] **Accessibility**: No keyboard navigation for UI, no screen reader support
- [ ] **No Persistence**: Game state lost on refresh (consider localStorage)

## Conventions

**Naming:**
- Components: PascalCase (`CameraRig.tsx`)
- Hooks: camelCase with `use` prefix (`useGameLoop.ts`)
- Utils: camelCase (`dungeonGenerator.ts`)
- Types: PascalCase interfaces (`Enemy`, `Item`)

**Structure:**
- One component per file
- Hooks in separate `hooks/` directory
- Shared types in `types/game.ts`
- State management centralized in `store/`

**Testing:**
- No test files present (opportunity for improvement)

**Styling:**
- Minimal CSS in `index.css`
- Inline styles for UI positioning
- No CSS-in-JS library

## Key Design Patterns

### Manual Position Sync (Lantern Fix)
Instead of using R3F's scene graph parenting (`camera.add()`), the lantern uses manual position copying:
```typescript
useFrame((state) => {
    if (lightRef.current) {
        lightRef.current.position.copy(state.camera.position)
    }
})
```
**Rationale**: R3F's declarative reconciler fights imperative scene graph manipulation.

### Atomic State Updates
Related state changes (movement + fog-of-war) are merged into single `set()` calls:
```typescript
set((state) => ({
    playerPosition: newPos,
    exploredMap: newExplored  // Updated together
}))
```
**Rationale**: Prevents race conditions and ensures UI consistency.

### Ref-Based Timeout Management
Animation timeouts use `useRef` to prevent memory leaks:
```typescript
useEffect(() => {
    if (timeoutRef.current) clearTimeout(timeoutRef.current)
    timeoutRef.current = setTimeout(...)
    return () => clearTimeout(timeoutRef.current)
}, [trigger])
```
**Rationale**: Ensures cleanup even if component unmounts mid-animation.
