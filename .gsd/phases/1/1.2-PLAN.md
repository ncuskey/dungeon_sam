---
phase: 1
plan: 1.2
wave: 1
---

# Plan 1.2: Grid Movement System

## Objective
Implement tight, grid-based movement controls (Dungeon Master/Grimrock style) with smooth camera transitions and collision detection against a map.

## Context
- .gsd/SPEC.md
- src/components/GameCanvas.tsx (created in 1.1)

## Tasks

<task type="auto">
  <name>Grid State & Input Store</name>
  <files>src/store/gameStore.ts</files>
  <action>
    Create a Zustand store (install `zustand`) `useGameStore`.
    State properties:
    - `playerPosition`: { x: number, y: number }
    - `playerDirection`: number (0=North, 1=East, 2=South, 3=West)
    - `map`: 2D array of numbers (0=empty, 1=wall)
    Actions:
    - `moveForward()`, `moveBackward()`, `turnLeft()`, `turnRight()`
    - Implement collision check: calculate target cell based on current pos + direction. If `map[target.y][target.x] !== 0`, block movement.
    Initialize with a hardcoded simple map (per roadmap).
  </action>
  <verify>Create a temporary unit test or run a script importing the store to verify state updates correctly on actions.</verify>
  <done>State updates correctly, collision prevents movement into walls</done>
</task>

<task type="auto">
  <name>Player Controller Component</name>
  <files>src/components/PlayerController.tsx</files>
  <action>
    Create `PlayerController` component that listens to `useEffect` specific key codes (ArrowUp/W, etc.).
    Map keys to store actions.
    Add Debounce/Cooldown to setting state to prevent instant gliding (simulating step time, e.g., 300ms).
  </action>
  <verify>Manual verification: keys trigger state changes (log to console)</verify>
  <done>Pressing keys updates store state with appropriate cooldowns</done>
</task>

<task type="auto">
  <name>Smooth Camera Rig</name>
  <files>src/components/CameraRig.tsx</files>
  <action>
    Create `CameraRig` component inside `<Canvas>`.
    Use `useFrame` to interpolate camera position/rotation to the target `playerPosition` and `playerDirection`.
    Math:
    - Target X/Z = `playerPosition.x * CELL_SIZE`, `playerPosition.y * CELL_SIZE`
    - Target Y = `EYE_HEIGHT` (constant)
    - Target Rotation Y = `playerDirection * -PI/2`
    - Use `THREE.MathUtils.lerp` for smooth transition.
  </action>
  <verify>Browser: Camera moves smoothly between grid cells when keys are pressed.</verify>
  <done>Camera moves and snaps to grid grid locations smoothly</done>
</task>

## Success Criteria
- [ ] Player moves strictly on grid
- [ ] Walls block movement
- [ ] Camera transitions are smooth (not instant teleport)
- [ ] Controls feel responsive but deliberate (retro feel)
