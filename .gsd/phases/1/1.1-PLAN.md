---
phase: 1
plan: 1
---

# Plan v0.4.1.1: Engine Repairs (State & Sync)

## Objective
Fix critical bugs in minimap exploration and player light synchronization.

## Tasks

<task type="auto">
  <name>Fix Minimap State Persistence</name>
  <files>src/store/gameStore.ts</files>
  <action>
    1. Refactor `revealMap` logic. Instead of calling it as a separate action inside `set`, create a helper `updateExploration(state, x, y)` that returns the new `exploredMap`.
    2. Update `moveForward`, `moveBackward`, `startGame`, and `resetGame` to use this helper directly within their `set` calls.
    3. This ensures exploration state is updated atomically with position changes.
  </action>
</task>

<task type="auto">
  <name>Fix Player Light Tracking</name>
  <files>src/components/CameraRig.tsx</files>
  <action>
    1. Instead of copying `state.camera.position` which includes lerp lag, sync the `lightRef` more aggressively or offset it slightly forward to avoid wall clipping.
    2. Increase camera lerp speed slightly (e.g., from 10 to 15) to make movement feel snappier.
  </action>
</task>

<task type="auto">
  <name>Potion Button Debug</name>
  <files>src/components/TouchControls.tsx, src/store/gameStore.ts</files>
  <action>
    1. Add console logging to `useItem` and the touch handler.
    2. Ensure `handleTouch` is correctly wrapping the `useItem` call.
    3. Fixed logic: `const potion = inventory.items.find(...)` should be verified against the state.
  </action>
</task>

## Success Criteria
- [ ] Minimap correctly reveals cells in a 3x3 radius as the player moves.
- [ ] Player light follows the character without visible lag or "detaching".
- [ ] Potion button correctly heals the player and is removed from inventory on tap.
